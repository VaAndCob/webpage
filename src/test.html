<!DOCTYPE html>
<html>
  <head>
    <title>Va&Cob Test Web</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <link rel="icon" href="fail.ico" type="image/x-icon" />
    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="stylesheet" href="./css/tabs.css" />
  </head>
  <body>
    <div class="tab-container">
      <div class="top-bar">
        <img src="./asset/logo.webp" width="50" height="50">
        <a href="https://www.youtube.com/@vaandcob" target="_blank"><img src="./asset/youtube.png" alt="YouTube" style="width:32px;height:32px;vertical-align:middle;"></a>
        <a href="https://www.facebook.com/vaandcob" target="_blank"><img src="./asset/facebook.png" alt="Facebook" style="width:32px;height:32px;vertical-align:middle;"></a>
        <button class="vibetime-button" onclick="window.open('https://vibetime.pages.dev', '_blank')">ðŸŽµ Vibetime</button>
        <a href="https://www.buymeacoffee.com/vaandcob"><img
          src="https://img.buymeacoffee.com/button-api/?text=Buy me a coffee&emoji=â˜•&slug=vaandcob&button_colour=FF5F5F&font_colour=ffffff&font_family=Cookie&outline_colour=000000&coffee_colour=FFDD00"/></a>
        
      </div>

      <div class="tabs">
        For testing:  PrintpooP
   
      </div>
      <ol>
        <li>Open this page in <strong>Google Chrome</strong> or <strong>Microsoft Edge</strong>.</li>
        <li>Connect the board to your computer via USB.</li>
        <li>Select the firmware version you want to flash.</li>
        <li>Click <strong>Flash</strong> to start the installation.</li>
        <li>When prompted:
          <ul>
            <li>Check <strong>Erase device</strong> for a clean installation (wipes all data).</li>
            <li>Uncheck it to update firmware while keeping settings.</li>
          </ul>
        </li>
      </ol>
      <div id="main">
      <fieldset>
        <legend>Select firmware</legend>
        <form id="select-firmware">
          <br>

          <input
            type="radio"
            id="device1"
            class="firmware-radio"
            name="device"
            value="firmware_1"
            onclick="setManifest('firmware_1')"
            checked
          />
          <label for="device1">Firmware 1</label><br />
          <br>
          <input
            type="radio"
            id="device2"
            class="firmware-radio"
            name="device"
            value="firmware_2"
            onclick="setManifest('firmware_2')"
          />
          <label for="device2">Firmware 2</label><br />
          <br>
          <input
            type="radio"
            id="device3"
            class="firmware-radio"
            name="device"
            value="firmware_3"
            onclick="setManifest('firmware_3')"
          />
          <label for="device3">Firmware 3</label><br />
          <br>
      
         
        </form>
        <hr />
           <div class="terminal-container">
          <textarea readonly id="terminal"></textarea>
        </div>
        <esp-web-install-button id="init-button">
          <button slot="activate" style="margin-top: 30px">Flash</button><br />
          <span slot="unsupported">Your browser doesn't support!</span><br />
          <span slot="not-allowed">Not support HTTP!</span>
        </esp-web-install-button>
     
      </fieldset>
    </div>

    </div>


  

 <script type="module" src="../../webserial/install-button.js?module"></script>
  <script>
    
   
      let url = "../../firmware/test/";
      const terminal = document.getElementById("terminal");
      //output message on terminal textarea
      function terminalOut(message) {
        terminal.value += message + "\n";
        terminal.scrollTop = terminal.scrollHeight; // Scroll to the bottom
      }


      // change init device manifest for flashing button
      function setManifest(device) {
        document
          .getElementById("init-button")
          .setAttribute("manifest", `${url}${device}_manifest.json`);
          terminal.value = "";//clear terminal
        terminalOut("Select firmware -> " + device);
        readManifest(device);
      }

      window.onload = function () {
        setManifest("firmware_1");
      };

      async function readManifest(device) {
        try {
          const response = await fetch(`${url}${device}_manifest.json`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const manifestData = await response.json();
          // Update the h2 heading
          document.querySelector(
            "h2"
          ).textContent = `${manifestData.name} - ${manifestData.version}`;
        } catch (error) {
          terminalOut(`Error reading manifest: ${error.message}`);
        }
      } 

    </script>
  </body>
</html>
