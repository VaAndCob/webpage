<!DOCTYPE html>
<html>
  <head>
    <title>PrintpooP</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="stylesheet" href="../css/tabs.css" />
  </head>

  <body>
    <h2 id="firmware-title">PrintpooP</h2>
    <a
      href="https://github.com/VaAndCob/PrintpooP"
      target="_blank"
      rel="noopener noreferrer"
      >Link to the project</a
    >
    <br /><br />

    <div id="main">
      <fieldset>
        <legend>Select firmware</legend>
        <form id="select-firmware">
          <!--Kitten-->
          <input
            type="radio"
            id="device1"
            class="firmware-radio"
            name="device"
            value="printpoop24_kitten"
            onclick="setManifest('printpoop24_1_kitten')"
            checked
          />
          <label for="device1">ğŸ± PrintpooP 2.4" Kitten Variant 1</label><br />
          <input
            type="radio"
            id="device1"
            class="firmware-radio"
            name="device"
            value="printpoop24_kitten"
            onclick="setManifest('printpoop24_2_kitten')"
            checked
          />
          <label for="device1">ğŸ± PrintpooP 2.4" Kitten Variant 2</label><br />
          <input
            type="radio"
            id="device2"
            class="firmware-radio"
            name="device"
            value="printpoop28_1_kitten"
            onclick="setManifest('printpoop28_1_kitten')"
          />
          <label for="device2">ğŸ± PrintpooP 2.8" Kitten Variant 1</label><br />
          <input
            type="radio"
            id="device3"
            class="firmware-radio"
            name="device"
            value="printpoop28_2_kitten"
            onclick="setManifest('printpoop28_2_kitten')"
          />
          <label for="device3"
            >ğŸ± PrintpooP 2.8" Kitten Variant 2</label><br />
          <hr />
          <!--Puppy-->
          <input
            type="radio"
            id="device4"
            class="firmware-radio"
            name="device"
            value="printpoop24_puppy"
            onclick="setManifest('printpoop24_1_puppy')"
          />
          <label for="device4">ğŸ¶ PrintpooP 2.4" Puppy Variant 1</label><br />
                  <input
            type="radio"
            id="device4"
            class="firmware-radio"
            name="device"
            value="printpoop24_puppy"
            onclick="setManifest('printpoop24_2_puppy')"
          />
          <label for="device4">ğŸ¶ PrintpooP 2.4" Puppy Variant 2</label><br />
          <input
            type="radio"
            id="device5"
            class="firmware-radio"
            name="device"
            value="printpoop28_1_puppy"
            onclick="setManifest('printpoop28_1_puppy')"
          />
          <label for="device5">ğŸ¶ PrintpooP 2.8" Puppy Variant 1</label><br />
          <input
            type="radio"
            id="device6"
            class="firmware-radio"
            name="device"
            value="printpoop28_2_puppy"
            onclick="setManifest('printpoop28_2_puppy')"
          />
          <label for="device6"
            >ğŸ¶ PrintpooP 2.8" Puppy Variant 2</label><br />
        </form>
        <hr />
           <div class="terminal-container">
          <textarea readonly id="terminal"></textarea>
        </div>
        <esp-web-install-button id="init-button">
          <button slot="activate" style="margin-top: 30px">Flash</button><br />
          <span slot="unsupported">Your browser doesn't support!</span><br />
          <span slot="not-allowed">Not support HTTP!</span>
        </esp-web-install-button>
     
      </fieldset>
    </div>

    <script
      type="module"
      src="../../webserial/install-button.js?module"
    ></script>

    <script>
      let url = "../../firmware/printpoop/";
      const terminal = document.getElementById("terminal");
      //output message on terminal textarea
      function terminalOut(message) {
        terminal.value += message + "\n";
        terminal.scrollTop = terminal.scrollHeight; // Scroll to the bottom
      }

      // change init device manifest for flashing button
      function setManifest(device) {
        document
          .getElementById("init-button")
          .setAttribute("manifest", `${url}${device}_manifest.json`);
          terminal.value = "";//clear terminal
        terminalOut("Select firmware -> " + device);
        readManifest(device);
      }

      window.onload = function () {
        setManifest("printpoop24_kitten");
      };

      async function readManifest(device) {
        try {
          const response = await fetch(`${url}${device}_manifest.json`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const manifestData = await response.json();
          // Update the h2 heading
          document.querySelector(
            "h2"
          ).textContent = `${manifestData.name} - ${manifestData.version}`;
        } catch (error) {
          terminalOut(`Error reading manifest: ${error.message}`);
        }
      }
    </script>
  </body>
</html>
