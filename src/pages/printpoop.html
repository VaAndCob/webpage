<!DOCTYPE html>
<html>
  <head>
    <title>PrintpooP Web Flasher</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="stylesheet" href="../css/tabs.css" />
  </head>

  <body>
    <h2 id="firmware-title">PrintpooP</h2>
    <div>
      1. Google Chrome or Microsoft Edge<br />
      2. Plug USB to the ESP32 2.4" or 2.8" TFT<br />
      3. Select the model<br />
      4. Click Flash to install firmware<br />
      5. Check "Erase device" for a new firmware install<br />
      Uncheck for only updating a new firmware version<br />
    </div>
    <br />
    <div id="main">
      <fieldset>
        <legend>Select firmware</legend>
        <form id="select-firmware">
          <input
            type="radio"
            id="device1"
            name="device"
            value="printpoop24"
            style="margin: 20px"
            onclick="setManifest('printpoop24')"
            checked
          />
          <label for="printpoop24">PrintpooP 2.4"</label><br />
          <input
            type="radio"
            id="device2"
            name="device"
            value="printpoop28_1"
            style="margin: 20px"
            onclick="setManifest('printpoop28_1')"
          />
          <label for="printpoop28_1">PrintpooP 2.8" Variant 1</label><br />
          <input
            type="radio"
            id="device3"
            name="device"
            value="printpoop28_2"
            style="margin: 20px"
            onclick="setManifest('printpoop28_2')"
          />
          <label for="printpoop28_2"
            >PrintpooP 2.8" Variant 2
            <a
              href="https://randomnerdtutorials.com/esp32-cheap-yellow-display-cyd-pinout-esp32-2432s028r/"
              target="_blank"
              rel="noopener noreferrer"
              >Randomnerd</a
            ></label
          ><br />
        </form>
        <hr />
        <esp-web-install-button
          manifest="../../firmware/printpoop/printpoop24_manifest.json"
          id="init-button"
        >
          <button slot="activate" style="margin-top: 30px">Flash</button><br />
          <span slot="unsupported">Your browser doesn't support!</span><br />
          <span slot="not-allowed">Not support HTTP!</span>
        </esp-web-install-button>
        <div class="terminal-container">
          <textarea readonly id="terminal"></textarea>
        </div>
      </fieldset>
    </div>

    <script
      type="module"
      src="../../webserial/install-button.js?module"
    ></script>

    <script>
      let url = "../../firmware/printpoop/";
      //output message on terminal textarea
      function terminalOut(message) {
        terminal.innerHTML += message + "\n";
        terminal.scrollTop = terminal.scrollHeight; // Scroll to the bottom
      }

      // change init device manifest for flashing button
      function setManifest(device) {
        document
          .getElementById("init-button")
          .setAttribute("manifest", `${url}${device}_manifest.json`);
        terminalOut("Select firmware -> " + device);
        readManifest(device);
      }

      window.onload = function () {
        setManifest("printpoop24");
      }

      async function readManifest(device) {
        try {
          const response = await fetch(`${url}${device}_manifest.json`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const manifestData = await response.json();
          // Update the h2 heading
          document.querySelector(
            "h2"
          ).textContent = `${manifestData.name} - ${manifestData.version}`;
        } catch (error) {
          terminalOut(`Error reading manifest: ${error.message}`);
        }
      }
    </script>
  </body>
</html>
